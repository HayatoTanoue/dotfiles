#!/bin/bash
# Claude Supervisor - interactive control panel for multiple Claude Code instances
# Polls ~/.claude-supervisor/status/ and displays numbered session list.
# Commands: {n} jump, {n}y approve, {n}n reject, {n} {text} send, q quit

set -euo pipefail

STATUS_DIR="$HOME/.claude-supervisor/status"
POLL_INTERVAL=2
STALE_THRESHOLD=3600  # 1 hour in seconds

# State display config
state_icon() {
  case "$1" in
    started)    echo "ðŸ”µ" ;;
    working)    echo "ðŸ”µ" ;;
    permission) echo "ðŸ”´" ;;
    idle)       echo "ðŸŸ¡" ;;
    stopped)    echo "ðŸŸ¢" ;;
    *)          echo "âšª" ;;
  esac
}

state_label() {
  case "$1" in
    started)    echo "é–‹å§‹"   ;;
    working)    echo "ä½œæ¥­ä¸­" ;;
    permission) echo "æ¨©é™å¾…ã¡" ;;
    idle)       echo "å…¥åŠ›å¾…ã¡" ;;
    stopped)    echo "å®Œäº†"   ;;
    *)          echo "$1"    ;;
  esac
}

# Track previous states for notification on change
declare -A PREV_STATES

# Indexed arrays for pane lookup
declare -a PANE_IDS=()
declare -a ENTRY_LINES=()

cleanup() {
  tput cnorm 2>/dev/null  # restore cursor
  printf "\n"
  exit 0
}
trap cleanup INT TERM

# Render the dashboard and return entries
render() {
  mkdir -p "$STATUS_DIR"

  # Collect status entries: sort_key|project|state|label|message|tmux_pane
  local entries=()

  for f in "$STATUS_DIR"/*.json; do
    [ -f "$f" ] || continue

    local session project state timestamp message tmux_pane
    session=$(jq -r '.session // empty' "$f" 2>/dev/null)
    project=$(jq -r '.project // empty' "$f" 2>/dev/null)
    state=$(jq -r '.state // empty' "$f" 2>/dev/null)
    timestamp=$(jq -r '.time // empty' "$f" 2>/dev/null)
    message=$(jq -r '.message // empty' "$f" 2>/dev/null)
    tmux_pane=$(jq -r '.tmux_pane // empty' "$f" 2>/dev/null)

    [ -z "$session" ] && continue

    # Check for stale entries
    local local_now file_time age
    local_now=$(date +%s)
    if date --version >/dev/null 2>&1; then
      file_time=$(date -d "$timestamp" +%s 2>/dev/null || echo "$local_now")
    else
      local converted
      converted=$(echo "$timestamp" | sed 's/T/ /;s/Z//')
      file_time=$(date -jf "%Y-%m-%d %H:%M:%S" "$converted" +%s 2>/dev/null || echo "$local_now")
    fi
    age=$((local_now - file_time))

    if [ "$age" -gt "$STALE_THRESHOLD" ]; then
      rm -f "$f"
      continue
    fi

    # Send tmux notification on state change to permission/idle
    if [ "$state" = "permission" ] || [ "$state" = "idle" ]; then
      local prev="${PREV_STATES[$session]:-}"
      if [ "$prev" != "$state" ] && [ -n "${TMUX:-}" ]; then
        local label
        label=$(state_label "$state")
        tmux set -g message-style "bg=#f7768e,fg=#1a1b26,bold"
        tmux display-message -d 5000 "  ðŸ”” $project: $label - $message  "
        (sleep 6 && tmux set -g message-style "bg=#7aa2f7,fg=#1a1b26") &
      fi
    fi
    PREV_STATES[$session]="$state"

    # Sort priority: permission=0, idle=1, working=2, started=3, stopped=4
    local sort_key
    case "$state" in
      permission) sort_key="0" ;;
      idle)       sort_key="1" ;;
      working)    sort_key="2" ;;
      started)    sort_key="3" ;;
      stopped)    sort_key="4" ;;
      *)          sort_key="5" ;;
    esac

    entries+=("${sort_key}|${project}|${state}|${message}|${tmux_pane}")
  done

  # Sort entries by priority
  local sorted=()
  if [ ${#entries[@]} -gt 0 ]; then
    IFS=$'\n' sorted=($(printf '%s\n' "${entries[@]}" | sort))
    unset IFS
  fi

  # Build indexed lists
  PANE_IDS=()
  ENTRY_LINES=()

  local idx=1
  for entry in "${sorted[@]}"; do
    local project state message tmux_pane icon label
    project=$(echo "$entry" | cut -d'|' -f2)
    state=$(echo "$entry" | cut -d'|' -f3)
    message=$(echo "$entry" | cut -d'|' -f4)
    tmux_pane=$(echo "$entry" | cut -d'|' -f5)

    icon=$(state_icon "$state")
    label=$(state_label "$state")

    PANE_IDS+=("$tmux_pane")

    local line
    line=$(printf " [%d] %s %-14s %s" "$idx" "$icon" "$project" "$label")
    if [ "$state" = "permission" ] || [ "$state" = "idle" ]; then
      line=$(printf "%s\n     â””â”€ %s" "$line" "$message")
    fi
    ENTRY_LINES+=("$line")

    idx=$((idx + 1))
  done

  # Render
  clear
  if [ ${#ENTRY_LINES[@]} -eq 0 ]; then
    echo " No active Claude sessions"
  else
    for line in "${ENTRY_LINES[@]}"; do
      echo "$line"
    done
  fi
}

# Execute a supervisor command
execute_cmd() {
  local cmd="$1"

  # q: quit
  if [ "$cmd" = "q" ]; then
    cleanup
  fi

  # Parse: {number}y, {number}n, {number} {text}, {number}
  local num rest
  if [[ "$cmd" =~ ^([0-9]+)y$ ]]; then
    num="${BASH_REMATCH[1]}"
    send_to_pane "$num" "y"
  elif [[ "$cmd" =~ ^([0-9]+)n$ ]]; then
    num="${BASH_REMATCH[1]}"
    send_to_pane "$num" "n"
  elif [[ "$cmd" =~ ^([0-9]+)[[:space:]]+(.+)$ ]]; then
    num="${BASH_REMATCH[1]}"
    rest="${BASH_REMATCH[2]}"
    send_to_pane "$num" "$rest"
  elif [[ "$cmd" =~ ^([0-9]+)$ ]]; then
    num="${BASH_REMATCH[1]}"
    jump_to_pane "$num"
  fi
}

send_to_pane() {
  local num="$1"
  local text="$2"
  local idx=$((num - 1))

  if [ "$idx" -lt 0 ] || [ "$idx" -ge "${#PANE_IDS[@]}" ]; then
    return
  fi

  local pane="${PANE_IDS[$idx]}"
  if [ -z "$pane" ]; then
    return
  fi

  tmux send-keys -t "$pane" "$text" Enter
}

jump_to_pane() {
  local num="$1"
  local idx=$((num - 1))

  if [ "$idx" -lt 0 ] || [ "$idx" -ge "${#PANE_IDS[@]}" ]; then
    return
  fi

  local pane="${PANE_IDS[$idx]}"
  if [ -z "$pane" ]; then
    return
  fi

  tmux select-pane -t "$pane"
}

# Main loop
while true; do
  render
  printf "\n > "
  tput cnorm 2>/dev/null  # show cursor for input

  if read -r -t "$POLL_INTERVAL" CMD; then
    CMD=$(echo "$CMD" | xargs)  # trim whitespace
    if [ -n "$CMD" ]; then
      execute_cmd "$CMD"
    fi
  fi
  # timeout â†’ re-render
done
