#!/bin/bash
# multi-claude - launch multiple Claude Code panes with orchestrator
# Usage: multi-claude [1|2|3|4]
#
# Layout:
# ┌────────────┬──────────┐
# │            │ Agent 1  │
# │orchestrator├──────────┤
# │            │ Agent 2  │
# ├────────────┤  ...     │
# │ supervisor │ Agent N  │
# ├────────────┤          │
# │ terminal   │          │
# └────────────┴──────────┘

AGENTS="${1:-2}"
SESSION="multi-claude"

if tmux has-session -t ${SESSION} 2>/dev/null; then
  tmux attach -t ${SESSION}
  exit 0
fi

# Clean up stale status/activity files from previous sessions
rm -f "$HOME/.claude-supervisor/status/"*.json 2>/dev/null
rm -f "$HOME/.claude-supervisor/activity/"*.jsonl 2>/dev/null

# Create session - initial pane becomes orchestrator
ORCH_PANE=$(tmux new-session -d -s ${SESSION} -P -F '#{pane_id}')

# Split left (40%) / right (60%) - right side for agents
FIRST_AGENT=$(tmux split-window -h -t "$ORCH_PANE" -p 60 -P -F '#{pane_id}')

# Split right side into N agent panes (evenly spaced)
LAST_AGENT="$FIRST_AGENT"
for i in $(seq 1 $((AGENTS - 1))); do
  REMAINING=$((AGENTS - i))
  PCT=$(( REMAINING * 100 / (REMAINING + 1) ))
  LAST_AGENT=$(tmux split-window -v -t "$LAST_AGENT" -p $PCT -P -F '#{pane_id}')
done

# Split left column: orchestrator (50%) / supervisor (25%) / terminal (25%)
tmux split-window -v -t "$ORCH_PANE" -p 50
tmux split-window -v -t "$ORCH_PANE" -p 50 "claude-supervisor"

# Start orchestrator in the top-left pane
tmux send-keys -t "$ORCH_PANE" "claude-orchestrator" Enter

# Tell supervisor where orchestrator is
mkdir -p "$HOME/.claude-supervisor"
echo "$ORCH_PANE" > "$HOME/.claude-supervisor/orchestrator-pane"

# Focus first agent pane
tmux select-pane -t "$FIRST_AGENT"

tmux attach -t ${SESSION}
