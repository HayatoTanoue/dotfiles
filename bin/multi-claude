#!/bin/bash
# 複数ペインでSSH + tmux セッションを開く
# 使い方: multi-claude <host> [columns]
#   multi-claude server1        - 2列構成 (デフォルト)
#   multi-claude server1 3      - 3列構成
#   multi-claude server1 4      - 4列構成
#
# レイアウト (例: 3列):
# ┌──────────┬──────────┬──────────┐
# │ terminal │ terminal │ terminal │
# ├──────────┼──────────┼──────────┤
# │ terminal │ terminal │ terminal │
# └──────────┴──────────┴──────────┘

if [ -z "$1" ]; then
  echo "Usage: multi-claude <host> [columns]"
  echo ""
  echo "Examples:"
  echo "  multi-claude server1       - 2列 x 2段 = 4ペイン"
  echo "  multi-claude server1 3     - 3列 x 2段 = 6ペイン"
  echo "  multi-claude server1 4     - 4列 x 2段 = 8ペイン"
  exit 1
fi

HOST="$1"
COLS="${2:-2}"
SESSION="multi-${HOST}"

ssh "$HOST" -t "
  if tmux has-session -t ${SESSION} 2>/dev/null; then
    tmux attach -t ${SESSION}
  else
    # 最初のペインを作成
    tmux new-session -d -s ${SESSION}

    # 横方向に分割 (columns - 1 回)
    for i in \$(seq 2 ${COLS}); do
      tmux split-window -h -t ${SESSION}
      tmux select-layout -t ${SESSION} even-horizontal
    done

    # 各列を縦に分割
    for i in \$(seq 0 \$(( ${COLS} - 1 ))); do
      tmux split-window -v -t ${SESSION}:\${TMUX_WINDOW:-0}.\${i}
    done

    tmux select-pane -t ${SESSION}:0.0
    tmux attach -t ${SESSION}
  fi
"
