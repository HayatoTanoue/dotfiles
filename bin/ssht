#!/bin/bash
# SSH + tmux 接続スクリプト
# 使い方: ssht hostname [dev] [path|alias]
#   ssht myserver                   - 3ペイン構成 (~)
#   ssht myserver dev               - dev構成 (~)
#   ssht myserver dev ~/project     - dev構成 (指定パス)
#   ssht myserver dev vgc           - dev構成 (エイリアス)
#
# dev レイアウト:
# Window 1 (dev):
# ┌──────────────┬─────────────────────┐
# │  filetree    │                     │
# ├──────────────┤     terminal        │
# │     tig      │                     │
# └──────────────┴─────────────────────┘
#      35%                65%
#
# Window 2 (git): lazygit

CONFIG_FILE="${HOME}/.config/ssht/paths"

# エイリアス展開
expand_alias() {
  local alias="$1"
  if [ -f "$CONFIG_FILE" ]; then
    local expanded=$(grep "^${alias}=" "$CONFIG_FILE" 2>/dev/null | cut -d'=' -f2-)
    if [ -n "$expanded" ]; then
      echo "$expanded"
      return
    fi
  fi
  echo "$alias"
}

if [ -z "$1" ]; then
  echo "Usage: ssht <hostname> [dev] [path|alias]"
  echo ""
  echo "Examples:"
  echo "  ssht myserver                - 3ペイン構成"
  echo "  ssht myserver dev            - dev構成 (yazi + tig + terminal + lazygit)"
  echo "  ssht myserver dev ~/project  - 指定ディレクトリでdev構成"
  echo "  ssht myserver dev vgc        - エイリアスでdev構成"
  echo ""
  echo "Config: $CONFIG_FILE"
  if [ -f "$CONFIG_FILE" ]; then
    echo ""
    echo "Aliases:"
    grep -v '^#' "$CONFIG_FILE" | grep -v '^$' | sed 's/^/  /'
  fi
  exit 1
fi

HOST="$1"
MODE="basic"
DIR=""

# 引数解析
if [ "$2" = "dev" ]; then
  MODE="dev"
  DIR="${3:-}"
elif [ -n "$2" ]; then
  DIR="$2"
fi

# エイリアス展開
if [ -n "$DIR" ]; then
  DIR=$(expand_alias "$DIR")
fi

# セッション名（dev-<basename> で統一）
if [ "$MODE" = "dev" ]; then
  if [ -n "$DIR" ]; then
    SESSION_NAME="dev-$(basename "$DIR")"
  else
    SESSION_NAME="dev"
  fi
else
  if [ -n "$DIR" ]; then
    SESSION_NAME=$(basename "$DIR")
  else
    SESSION_NAME="main"
  fi
fi

if [ "$MODE" = "dev" ]; then
  # dev構成: Window1(yazi+tig+terminal) + Window2(lazygit)
  ssh "$HOST" -t "
    TARGET_DIR=\"${DIR:-\$HOME}\"
    cd \"\$TARGET_DIR\" 2>/dev/null || TARGET_DIR=\$HOME

    if tmux has-session -t ${SESSION_NAME} 2>/dev/null; then
      tmux attach -t ${SESSION_NAME}
    else
      tmux new-session -s ${SESSION_NAME} -n dev -c \"\$TARGET_DIR\" \\; \\
        split-window -hb -l 35% -c \"\$TARGET_DIR\" \\; \\
        send-keys \"ft \\\"\$TARGET_DIR\\\"\" C-m \\; \\
        split-window -v -l 50% -c \"\$TARGET_DIR\" \\; \\
        send-keys \"tig\" C-m \\; \\
        new-window -n git -c \"\$TARGET_DIR\" \\; \\
        send-keys \"lazygit\" C-m \\; \\
        select-window -t dev \\; \\
        select-pane -R
    fi
  "
else
  # basic構成: 3ペイン
  ssh "$HOST" -t "
    TARGET_DIR=\"${DIR:-\$HOME}\"
    cd \"\$TARGET_DIR\" 2>/dev/null || TARGET_DIR=\$HOME

    if tmux has-session -t ${SESSION_NAME} 2>/dev/null; then
      tmux attach -t ${SESSION_NAME}
    else
      tmux new-session -s ${SESSION_NAME} -c \"\$TARGET_DIR\" \\; \\
        split-window -h -c \"\$TARGET_DIR\" \\; \\
        split-window -v -c \"\$TARGET_DIR\" \\; \\
        select-pane -t 0
    fi
  "
fi
